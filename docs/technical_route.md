# 技术路线文档 (Technical Route Document)

## 1. 总体架构设计
本项目采用 **分层架构**，将业务逻辑、页面交互和数据处理分离，以提高代码的可维护性和扩展性。

### 1.1 模块划分
*   **控制层 (Controller)**: `main.py` - 负责程序的生命周期管理、任务调度和异常捕获。
*   **采集层 (Scraper)**: `scraper.py` - 封装 Playwright 操作，负责与抖音网页进行交互（搜索、滚动、点击）。
*   **工具层 (Utils)**: `utils.py` - 提供通用功能，如时间解析、关键词匹配、文件读写。
*   **数据层 (Data)**: CSV 文件 - 采用扁平化存储，方便后续分析。

## 2. 详细技术方案

### 2.1 核心技术栈
*   **运行环境**: Python 3.10+
*   **浏览器自动化**: `playwright` (同步模式 `sync_playwright`)
    *   *选择理由*: 相比 Selenium，Playwright 速度更快，对现代动态网页支持更好，且原生支持拦截网络请求（虽然本项目主要基于 DOM，但保留网络拦截能力很有用）。
*   **数据处理**: `pandas` (用于清洗和保存 CSV)

### 2.2 关键流程逻辑

#### A. 初始化与反检测
1.  **启动配置**:
    *   `headless=False`: 必须有头模式，否则极易触发滑块。
    *   `args=['--disable-blink-features=AutomationControlled']`: 移除自动化特征。
    *   `user_agent`: 使用随机或固定的真实浏览器 UA。
2.  **Cookie 管理**:
    *   首次运行需人工登录。
    *   保存 `auth.json` (Storage State)，后续运行自动加载。

#### B. 搜索与筛选
1.  **搜索**: 定位搜索框 `input[type="search"]` -> 输入关键词 -> 模拟回车。
2.  **时间筛选**:
    *   定位“筛选”按钮 -> 点击。
    *   定位“发布时间”下拉菜单 -> 选择“过去一周” (或“一天内”)。
    *   *注意*: 抖音 UI 经常变动，需使用更稳健的文本定位 (Text Selector) 而非纯 CSS 类名。

#### C. 视频列表遍历
1.  **无限滚动**: 模拟鼠标滚轮 `page.mouse.wheel(0, 1000)`。
2.  **停止条件**: 采集数量达到目标 或 视频发布时间超过3天（需解析视频卡片上的时间文本）。
3.  **去重**: 使用 `video_id` 或 `url` 进行集合去重。

#### D. 评论采集 (详情页模式)
1.  **进入详情**: 点击视频卡片，等待新页面或弹窗加载。
2.  **评论区加载**: 滚动评论区容器。
3.  **内容提取**:
    *   **用户名**: `.user-info .name` (示例选择器)
    *   **评论内容**: `.comment-text`
    *   **时间**: `.comment-time`
4.  **关键词过滤**:
    *   在内存中即时过滤：`if any(k in content for k in keywords): save()`

### 2.3 数据模型
| 字段名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `video_title` | str | 视频标题 |
| `video_url` | str | 视频链接 |
| `author_name` | str | 评论者昵称 |
| `comment_text` | str | 评论内容 |
| `comment_time` | str | 评论发布时间 (原始文本) |
| `capture_time` | str | 采集时间戳 |
| `matched_keyword` | str | 命中的关键词 |

## 3. 异常处理策略
*   **元素未找到 (TimeoutError)**: 捕获异常，截图保存至 `data/logs/`，跳过当前视频。
*   **验证码 (Captcha)**: 检测到特定元素时，暂停程序 `input("请手动完成验证后按回车...")`。

## 4. 开发规范
*   **目录**: 严格遵守 `src/` 存放代码，`docs/` 存放文档。
*   **注释**: 关键逻辑必须包含中文注释。
*   **类型提示**: 所有函数必须包含 Type Hints。
